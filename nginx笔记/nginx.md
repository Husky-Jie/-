# 1.Nginx

Nginx （engine x） 是一个高性能的Web服务器和反向代理服务器，也可以作为邮件代理服务器。

Nginx 特点是占有内存少，并发处理能力强，以高性能、低系统资源消耗而闻名，Nginx官方测试为5万并发请求。与Nginx同类型的Web服务器还有Apache、Lighttpd（音同lighty）、Tengine（阿里巴巴的） 等。Nginx 的并发处理能力在同类型的Web服务器中表现极好（Apache、Lighttpd），在全世界范围内大量的网站使用了Nginx，国内互联网中也大量使用了Nginx，比如：淘宝、新浪、搜狐、网易、美团等。

Nginx是免费开源的，同时Nginx也有收费的商业版本，商业版本提供了性能优化、宕机等紧急问题处理等技术支持和服务。



**正向代理代理对象是客户端，反向代理代理对象是服务端。**

## 1.1正向代理

正向代理
先搭建一个属于自己的代理服务器
1、用户发送请求到自己的代理服务器
2、自己的代理服务器发送请求到服务器
3、服务器将数据返回到自己的代理服务器
4、自己的代理服务器再将数据返回给用户
作用：正向代理隐藏了用户，用户的请求被代理服务器接收代替，到了服务器，服务器并不知道用户是谁。
用途：当你用浏览器访问国外的网站时，被block(拒绝)时，你可以在国外搭建一个代理服务器，这样就可以正常访问了（只是举一个列子）

正向代理类似一个跳板机，代理访问外部资源。比如：我是一个用户，我访问不了某网站，但是我能访问一个代理服务器，这个代理服务器，它能访问那个我不能访问的网站，于是我先连上代理服务器，告诉它我需要那个无法访问网站的内容，代理服务器去取回来,然后返回给我。

![image-20221104222343671](assets\image-20221104222343671.png)

```markdown
例子（理解正向代理）：
比如你现在缺钱，想找马云爸爸去借钱，可想而知人家可能鸟都不鸟你，到最后碰一鼻子灰借不到钱。不过你认识你家隔壁老王，而老王认识马云同志，而且关系还很好。这时候你托老王去找马云借钱，当然这事最后成了，你从马云那里借到了500万！这时候马云并不知道钱是你借的，只知道这钱是老王借的。最后由老王把钱转交给你。在这里，老王就充当了一个重要的角色：代理。
此时的代理，就是我们常说的正向代理。代理客户端去请求服务器，隐藏了真实客户端，服务器并不知道真实的客户端是谁。正向代理应用最广泛的莫过于现在的某些“科学上网工具”，你访问不了谷歌、Facebook的时候，你可以在国外搭建一台代理服务器，代理你访问，代理服务器再把请求到的数据转交给你，你就可以看到内容了。

```



## 1.2反向代理

反向代理（Reverse Proxy）方式是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器；

反向代理
1、用户发送请求到服务器（访问的其实是反向代理服务器，但用户不知道）
2、反向代理服务器发送请求到真正的服务器
3、真正的服务器将数据返回给反向代理服务器
4、反向代理服务器再将数据返回给用户
作用：用户请求过多，服务器会有一个处理的极限。所以使用反向代理服务器接受请求，再用均衡负载将请求分布给多个真实的服务器。既能提高效率还有一定的安全性。
用途：如果不采用代理，用户的IP、端口号直接暴露在Internet（尽管地址转换NAT），外部主机依然可以根据IP、端口号来开采主机安全漏洞，所以在企业网，一般都是采用代理服务器访问互联网。

![image-20221104223316682](assets\image-20221104223316682.png)

```markdown
例子（理解反向代理）：
比如你现在很无聊，想找人聊天，这时候你拨通了联通客服10010电话，联通的总机可能随机给你分配一个闲置的客服给你接通。这时候你如愿以偿的和客服聊了起来，问了问她目前有没有结婚、有没有对象、家住哪里、她的微信号、她的手机号。。。
此时联通总机充当的角色就是反向代理，你只知道和客服接通并聊了起来，具体为什么会接通这个客服MM，怎么接通的，你并不知道。
反向代理隐藏了真正的服务端，就像你每天使用百度的时候，只知道敲打www.baidu.com就可以打开百度搜索页面，但背后成千上万台百度服务器具体是哪一台为我们服务的，我们并不知道。我们只知道这个代理服务器，它会把我们的请求转发到真实为我们服务的那台服务器那里去。

```

## 1.3两者最简单的区别

正向代理与反向代理最简单的区别：
正向代理隐藏的是用户，反向代理隐藏的是服务器

# 2.Nginx环境搭建（Linux）

## 2.1下载及安装

下载地址：http://nginx.org 

**安装前的准备：**

（1）  gcc编译器是否安装

​     检查是否安装：yum list installed | grep gcc

​     执行安装：yum install gcc -y

（2）  openssl库是否安装

​     检查是否安装：yum list installed | grep openssl

​     执行安装：yum install openssl openssl-devel -y

（3）  pcre库是否安装

​     检查是否安装：yum list installed | grep pcre

​     执行安装：yum install pcre pcre-devel -y

（4）  zlib库是否安装

​     检查是否安装：yum list installed | grep zlib

​     执行安装：yum install zlib zlib-devel -y

（5）  一次性安装，执行如下命令

yum install gcc openssl openssl-devel pcre pcre-devel zlib zlib-devel -y

**正式安装：**

1.  解压下载下来的nginx文件，执行命令：tar -zxvf nginx-1.14.2.tar.gz
2.  切换至解压后的nginx主目录，执行命令：cd nginx-1.14.2
3.  在nginx主目录nginx-1.14.2下执行命令：./configure --prefix=/usr/local/nginx 
4. （其中--prefix是指定nginx安装路径） 注意:等号左右不要有空格
5. 执行命令进行编译：make
6.  执行命令进行安装：make install

安装成功后，可以切换到/usr/local/nginx目录下，查看内容



## 2.3使用Nginx

**普通启动：**

切换到nginx安装目录的sbin目录下，执行：./nginx

**通过配置文件启动：**

nginx绝对路径 -c nginx.conf文件的绝对路径

其中-c是指定配置文件,而且配置文件路径必须指定绝对路径

**关闭Nginx：**

kill 主pid

**重启Nginx：**

./nginx -s reload

## 2.4Nginx目录结构

![image-20221104105800893](assets\image-20221104105800893.png)

## 2.5Nginx命令

要在nginx目录下的sbin执行命令

![image-20221104110304195](assets\image-20221104110304195.png)

1. 查看Nginx版本：./nginx -v

2. 检查配置文件的正确性：./nginx -t

3. 启动Nginx：./nginx

   需要关闭防火墙才能访问地址  systemctl stop firewalld

   启动成功后 /usr/local/nginx/logs下的nginx.pid文件记录的是nginx启动的进程id

4. 停止Nginx：./nginx -s stop

5. 启动后查看Nginx进程：ps -ef | grep nginx

6. 当修改配置文件后，需要重新加载配置文件才能生效

   重新加载配置文件：./nginx -s reload

# 3.Nginx配置文件结构

Nginx整体分为三部分（/nginx/conf/nginx.conf）：

![image-20221104214403562](assets\image-20221104214403562.png)

## 3.1全局块

和Nginx运行相关的全局配置

## 3.2events块

和网络连接相关的配置

## 3.3http块

和代理、缓存、日志记录、虚拟机配置；

http块可以配置多个Server块，每个server块中可以配置多个location块

http块又分为

![image-20221104215152031](assets\image-20221104215152031.png)

### server全局块：

listen：监听端口号

server_name：域名（服务器名称）

upstream：该指令可以定义一组服务器

```java
// 写法
upstream 名称{
    server 192.168.108.128:8080;
    server 192.168.108.129:8080;
    .
    .
    .// 可写多个
}
```



### location块：

![image-20221104220853265](assets\image-20221104220853265.png)

location：匹配客户端请求url

root：表示根，访问html根目录下的资源

index：表示访问主页面，后面可跟着多个页面一个一个往下找，找不到报404

proxy_pass：反向代理配置，将请求转发到指定服务

# 4.静态网站部署

Nginx是一个HTTP的web服务器，可以将服务器上的静态文件（如HTML、图片等）通过HTTP协议返回给浏览器客户端。

相对于Tomcat，Nginx处理静态资源的能力更高效，所以在生产环境下，一般都会将静态资源部署到Nginx中。

将静态资源（文件）部署到Nginx目录下的html目录下即可

# 5.负载均衡策略

## 5.1轮询

描述： 所有请求按照时间顺序地轮流分配到应用服务器上，它可以均衡的将负载分散在后端服务器上，但是并不关心后端服务器的连接数和系统负载，它是默认的负载均衡策略。在轮序中如果服务器宕机了会自动移除服务器。一般用于后端服务器性能均等的情况下。

参数：

![image-20221104225518961](assets\image-20221104225518961-16675737256031.png)

配置例子：

```markdown
upstream xx.com{
	server 192.168.12.100:5000 fail_timeout=2s max_fails=1;
	server 192.168.12.101:5000 fail_timeout=2s max_fails=1;
}
```

## 5.2权重weight

**概述：** 在轮询算法的基础上指定轮询的概率。权重越高被分配的记录越大，适合服务器硬件配置有一定差距的情况

**配置例子**

```markdown
upstream xx.com{
	server 192.168.12.100:5000 weight=1;
	server 192.168.12.101:5000 weight=1;
	server 192.168.12.101:5000 weight=3;
}
```



## 5.3ip_hash

**概述：** 通过对IP的Hash值进行计算然后选择分配的服务器。这个方法可以使客户端的请求发送到相同的服务器以保证session会话，并且可以使用权重

**配置例子**：

```markdown
upstream xx.com{
        ip_hash;    #保证每个访客固定访问一个后端服务器
        server localhost:8080   weight=2; 
        server localhost:8081;  
        server localhost:8082;  
        server localhost:8083   max_fails=3 fail_timeout=20s;  
}
注意：
使用IP_Hash需要Nginx是最前端的服务器，否则无法获取到正确的客户端IP。
如果在IP_Hash的Nginx服务器之后还有其他的负载均衡，那么具体请求落在某一台服务器就无法确定了。
```

## 5.4least_conn

**概述：** 最小连接算法，它会选择后台服务器中积压的连接数最少的服务器来处理当前请求。

nginx内部会记录每个后台服务器当前的连接数和权重，使用最小连接算法时，会选出后台服务器中连接数/权重`最小`的服务器处理请求。

## 5.5第三方策略

- **fair：** 按照服务端响应时间来分配请求，响应时间最短的优先分配。
- **url_hash：** 根据URL的hash结果来分配请求，它会使每个URL定向到同一个后端服务器中